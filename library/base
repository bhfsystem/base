#!/usr/bin/env bash
# WANT_JSON

exec 4>&1

function main {
  local shome="$(cd -P -- "${BASH_SOURCE%/*}/.." && pwd -P)"

  local pth_log="$(mktemp -t XXXXXX)"
  local done=
  trap 'if [[ -z "${done:-}" ]]; then cat $pth_log; else rm -f $pth_log; fi' EXIT
  exec 1>&2 2>>"$pth_log"
  set -exfu

  if [[ "$#" -gt 0 ]]; then 
    eval $(cat "$1" | jq -r 'to_entries | map(select(.value | type == "string")) | map("\(.key)=" + @sh "\(.value)") | .[]')
    shift
  fi

  if doit; then
    jq -n -c -M \
      --arg log "$(cat "$pth_log")" \
    '{
      changed: true, 
      log: "\($log)"
    }' 1>&4
    done=1
  fi
}

function doit {
  sudo apt-get update
  sudo dpkg --remove-architecture i386
  sudo apt-get install -y software-properties-common python-software-properties openssh-server apt-get
  sudo env - add-apt-repository -y ppa:git-core/ppa
  sudo env - add-apt-repository -y ppa:ubuntu-lxc/lxd-stable
  sudo apt-get purge -y nano mlocate ubuntu-release-upgrader-core update-manager-core
  sudo apt-get update -y && sudo -E apt-get upgrade -y
  sudo apt-get install -y net-tools sudo cloud-init dnsmasq git curl unzip perl ruby python language-pack-en build-essential vim man screen tmux
  sudo apt-get install -y libffi-dev libssl-dev libreadline-dev build-essential zlib1g-dev libxml2-dev libxslt1-dev autoconf automake libtool
  sudo mkdir -p /var/run/sshd
}

main "$@"
